<html>
<head>
    <title>WebRTC with SkylinkJS</title>
  <script src="https://cdn.temasys.io/skylink/skylinkjs/0.6.x/skylink.complete.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://github.com/lpnott/WebAudioTrack/blob/master/WebAudioTrack.js"></script>
  <style>
  header {
  background: #eee;
  padding: 20px;
  font-family: Helvetica, Arial, sans-serif;
}

header a:first-child {
  float: right;
  margin: 0 0 20px 30px;
}

button {
  display: inline-block;
  position: relative;
  top: 110px;
  left: 110px;
  z-index: 10;
}

video {
  width: 267px;
  height: 200px;
  border: 1px solid white;
  outline: 1px solid #ccc;
  z-index: 5;
}

#myvideo {
  transform: rotateY(-180deg);
}

#start {
  display: none;
}</style>
</head>
<body>

  <header>
    <a href="https://temasys.github.io" target="_blank">SkylinkJS on Github</a>
    You're in a private room. Please click &quot;Start&quot;, allow access to your microphone and camera and <a href="https://codepen.io/temasys/pen/GogabE" target="_blank">click here</a> to open this page in a new tab. You're joining yourself for a fun call ;)
  </header>
  
  <p id="status">Loading room information...</p>
 
  <div id="start">
    <button  onclick="start(event)">Start</button><br/>
    <video id="myvideo" autoplay muted></video>
  </div>
    <div id="container">
        <div id="player">
                    <button id="btn-start-recording">Start Recording</button>
        <button id="btn-stop-recording" disabled>Stop Recording</button>
        <br>
        <button id="btn-play-recording" disabled>Play Recording</button>
        <button id="btn-play-file">Play File</button>
        <button id="btn-play-both" disabled>Play Both</button>
        </div>
    </div>
  
</body>
<script>
var skylink = new Skylink();
skylink.setLogLevel(4);
skylink.on('peerJoined', function(peerId, peerInfo, isSelf) {
  if(isSelf) return; // We already have a video element for our video and don't need to create a new one.
  var vid = document.createElement('video');
  vid.autoplay = true;
  vid.muted = true; // Added to avoid feedback when testing locally
  vid.id = peerId;
  document.body.appendChild(vid);
});

skylink.on('incomingStream', function(peerId, stream, isSelf) {
  if(isSelf) return;
  var vid = document.getElementById(peerId);
  attachMediaStream(vid, stream);
});

skylink.on('peerLeft', function(peerId) {
  var vid = document.getElementById(peerId);
  document.body.removeChild(vid);
});

skylink.on('mediaAccessSuccess', function(stream) {
  var vid = document.getElementById('myvideo');
  attachMediaStream(vid, stream);
});

skylink.init({
  apiKey: 'd01af995-1e98-4116-8645-11bfc90c8d29', // Get your own key at https://console.temasys.io
  defaultRoom: 'GogabE'//getRoomId()
}, function (error, success) {
  if (error) {
    document.getElementById('status').innerHTML = 'Failed retrieval for room information.<br>Error: ' + (error.error.message || error.error);
  } else {
       document.getElementById('status').innerHTML = 'Room information has been loaded. Room is ready for user to join.';
    document.getElementById('start').style.display = 'block';
  }
});

function start(event) {
  event.target.style.visibility = 'hidden';
  
  skylink.joinRoom({
    audio: true,
    video: false
  }, function (error, success) {
    if (error) {
      document.getElementById('status').innerHTML = 'Failed joining room.<br>' +
  'Error: ' + (error.error.message || error.error);
    } else {
      document.getElementById('status').innerHTML = 'Joined room.';
    }
  });
}


/* Helper functions */

function getRoomId() {
  var roomId = document.cookie.match(/roomId=([a-z0-9-]{36})/);
  if(roomId) {
    return roomId[1];
  }
  else {
    roomId = skylink.generateUUID();
    var date = new Date();
    date.setTime(date.getTime() + (30*24*60*60*1000));
    document.cookie = 'roomId=' + roomId + '; expires=' + date.toGMTString() + '; path=/';
    return roomId;
  }
};
     var audioTrack = new WebAudioTrack();
    var audioTrackFile = new WebAudioTrack();
    var startButton = document.getElementById('btn-start-recording');
    var stopButton = document.getElementById('btn-stop-recording');
    var playRecButton = document.getElementById('btn-play-recording');
    var playFileButton = document.getElementById('btn-play-file');
    var playBothButton = document.getElementById('btn-play-both');
    startButton.addEventListener("click", function() {
        audioTrack.startRecording(function() {
            stopButton.disabled = false;
            startButton.disabled = true;
        });
    });
    stopButton.addEventListener("click", function() {
        audioTrack.stopRecording(function() {
            startButton.disabled = false;
            stopButton.disabled = true;
            playRecButton.disabled = false;
            playBothButton.disabled = false;
        });
    });
    playRecButton.addEventListener("click", function() {
        audioTrack.play();
    });
    playFileButton.addEventListener("click", function() {
        audioTrackFile.loadUrl("audio-1.m4a")
            .then(audioTrackFile.play)
    });
    playBothButton.addEventListener("click", function() {
        var newTrack = new WebAudioTrack();
        newTrack.loadUrl("audio-2.m4a")
            .then(function() {
                newTrack.appendAudioFromTrack(audioTrack);
                newTrack.play();
            })
    });

</script> 
</html>
